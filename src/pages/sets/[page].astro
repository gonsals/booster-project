---
import "@/styles/global.css";
import MainLayout from "@/layouts/MainLayout.astro";
import SetCard from "@/components/SetCard.astro";
import SetCardSkeleton from "@/components/SetCardSkeleton.astro";
import { getSetList } from "@/lib/setList";
import type { SealedProduct } from "@/types/mtgjson/SealedProduct";
import type { Set } from "@/types/mtgjson/Set";

type BoosterFlags = {
    play: boolean;
    collector: boolean;
};

export async function getStaticPaths({ paginate }: { paginate: any }) {
    const { data = [] } = await getSetList();

    function getBoosterTypes(sealed: SealedProduct[] = []): BoosterFlags {
        return {
            play: sealed.some(
                (p) =>
                    /play|draft/i.test(p.name) ||
                    /play|draft/i.test(p.subtype ?? "")
            ),
            collector: sealed.some((p) => /collector/i.test(p.name)),
        };
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const items = data
        .filter((s) => Array.isArray(s.sealedProduct) && s.sealedProduct.length)
        .map((s) => {
            const release = new Date(s.releaseDate);
            release.setHours(0, 0, 0, 0);

            const boosters = getBoosterTypes(s.sealedProduct);

            return {
                name: s.name,
                code: s.code.toLowerCase(),
                releaseDate: s.releaseDate,
                isUpcoming: release > today,
                boosters,
            };
        })
        .filter((s) => s.boosters.play || s.boosters.collector)
        .sort(
            (a, b) =>
                new Date(b.releaseDate).getTime() -
                new Date(a.releaseDate).getTime()
        );

    return paginate(items, { pageSize: 18 });
}

const { page } = Astro.props as { page: any };
const items = page?.data ?? ([] as Set[]);
const isLoading = !items.length;
---

<html lang="en" transition:animate="fade">
    <MainLayout content={{ title: `MTG TOP PICKS – Page ${page.currentPage}` }}>
        <main class="mx-auto max-w-6xl p-6">
            <!-- HEADER -->
            <header
                class="mb-6 flex flex-wrap items-center justify-between gap-4"
            >
                <div>
                    <h1
                        class="text-3xl font-extrabold tracking-tight text-gray-900"
                    >
                        Sets con Boosters
                    </h1>
                    <p class="mt-2 text-sm text-gray-600">
                        Página {page.currentPage} de {page.lastPage} · Mostrando
                        {page.start + 1}–{page.end} de {page.total}
                    </p>
                </div>

                <a
                    href="/"
                    class="inline-flex items-center rounded-md border bg-white px-3 py-1.5 text-sm text-sky-700 hover:bg-sky-50"
                >
                    Inicio
                </a>
            </header>

            <!-- GRID -->
            <section class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                {
                    isLoading
                        ? Array.from({ length: 6 }).map(() => (
                              <SetCardSkeleton />
                          ))
                        : items.map((set: Set) => <SetCard set={set} />)
                }
            </section>

            <!-- PAGINACIÓN -->
            <nav class="mt-8 flex items-center justify-between text-sm">
                <div class="flex gap-2">
                    {
                        page.url.first && (
                            <a
                                href={page.url.first}
                                class="rounded border bg-white px-3 py-1 hover:bg-gray-50"
                            >
                                First
                            </a>
                        )
                    }
                    {
                        page.url.prev && (
                            <a
                                href={page.url.prev}
                                class="rounded border bg-white px-3 py-1 hover:bg-gray-50"
                            >
                                Prev
                            </a>
                        )
                    }
                </div>

                <div class="text-gray-600">
                    Página {page.currentPage} / {page.lastPage}
                </div>

                <div class="flex gap-2">
                    {
                        page.url.next && (
                            <a
                                href={page.url.next}
                                class="rounded border bg-white px-3 py-1 hover:bg-gray-50"
                            >
                                Next
                            </a>
                        )
                    }
                    {
                        page.url.last && (
                            <a
                                href={page.url.last}
                                class="rounded border bg-white px-3 py-1 hover:bg-gray-50"
                            >
                                Last
                            </a>
                        )
                    }
                </div>
            </nav>
        </main>
    </MainLayout>
</html>
