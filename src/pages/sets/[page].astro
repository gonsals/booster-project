---
import "../../styles/global.css";
import MainLayout from "../../layouts/MainLayout.astro";

export async function getStaticPaths({ paginate }) {
    const res = await fetch("https://mtgjson.com/api/v5/SetList.json");
    const json = await res.json();

    const sets = Array.isArray(json?.data) ? json.data : [];

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const items = sets
        .filter((s) => Array.isArray(s?.sealedProduct) && s.sealedProduct.length)
        .map((s) => {
            const release = new Date(s.releaseDate);
            release.setHours(0, 0, 0, 0);

            const sealedText = s.sealedProduct
                .map((p) => `${p.name} ${p.subtype ?? ""}`.toLowerCase())
                .join(" ");

            return {
                name: s.name,
                code: s.code.toLowerCase(),
                releaseDate: s.releaseDate,
                isUpcoming: release > today,
                boosters: {
                    play: /(play|draft)/.test(sealedText),
                    collector: /collector/.test(sealedText),
                },
            };
        })
        .filter(
            (s) =>
                s.boosters.play ||
                s.boosters.collector        
            )
        .sort(
            (a, b) =>
                new Date(b.releaseDate).getTime() -
                new Date(a.releaseDate).getTime()
        );

    return paginate(items, { pageSize: 20 });
}

const { page } = Astro.props;
const items = page.data ?? [];
---

<html lang="en">
    <MainLayout content={{ title: `Sets con Boosters – Página ${page.currentPage}` }}>
        <main class="mx-auto max-w-6xl p-6">
            <!-- HEADER -->
            <header class="mb-6 flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-gray-900">
                        Sets con Boosters
                    </h1>
                    <p class="mt-2 text-sm text-gray-600">
                        Página {page.currentPage} de {page.lastPage} · Mostrando
                        {page.start + 1}–{page.end} de {page.total}
                    </p>
                </div>

                <a
                    href="/"
                    class="inline-flex items-center rounded-md border bg-white px-3 py-1.5 text-sm text-sky-700 hover:bg-sky-50"
                >
                    Inicio
                </a>
            </header>

            <!-- GRID -->
            <section class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                {
                    items.length ? (
                        items.map((it) => (
                            <article
                                class={`relative rounded-xl border bg-white p-5 shadow-sm transition ${
                                    it.isUpcoming
                                        ? "opacity-80"
                                        : "hover:-translate-y-0.5 hover:shadow-md"
                                }`}
                            >
                                {it.isUpcoming && (
                                    <span class="absolute right-3 top-3 rounded-full bg-amber-100 px-2.5 py-1 text-xs font-semibold text-amber-700">
                                        Próximamente
                                    </span>
                                )}

                                <a
                                    href={`/sets/boosters/${it.code}`}
                                    class="block text-lg font-semibold text-sky-700 hover:underline"
                                >
                                    {it.name}
                                </a>

                                <div class="mt-3 text-sm text-gray-600">
                                    <div>
                                        <span class="text-gray-400">Lanzamiento:</span>{" "}
                                        <span class="font-medium">
                                            {it.releaseDate}
                                        </span>
                                    </div>
                                </div>

                                <!-- Booster types -->
                                <div class="mt-4 flex flex-wrap gap-2">
                                    {it.boosters.play && (
                                        <span class="rounded-md bg-sky-100 px-2 py-1 text-xs font-medium text-sky-700">
                                            Play Booster
                                        </span>
                                    )}
                                    {it.boosters.collector && (
                                        <span class="rounded-md bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">
                                            Collector
                                        </span>
                                    )}
                                </div>

                                {it.isUpcoming && (
                                    <p class="mt-3 text-xs text-gray-400">
                                        Este set aún no ha sido lanzado.
                                    </p>
                                )}
                            </article>
                        ))
                    ) : (
                        <div class="col-span-full rounded-md border bg-white p-6 text-sm text-gray-600">
                            No hay sets disponibles.
                        </div>
                    )
                }
            </section>

            <!-- PAGINACIÓN -->
            <nav class="mt-8 flex items-center justify-between text-sm">
                <div class="flex gap-2">
                    {page.url.first && (
                        <a href={page.url.first} class="rounded border bg-white px-3 py-1 hover:bg-gray-50">
                            First
                        </a>
                    )}
                    {page.url.prev && (
                        <a href={page.url.prev} class="rounded border bg-white px-3 py-1 hover:bg-gray-50">
                            Prev
                        </a>
                    )}
                </div>

                <div class="text-gray-600">
                    Página {page.currentPage} / {page.lastPage}
                </div>

                <div class="flex gap-2">
                    {page.url.next && (
                        <a href={page.url.next} class="rounded border bg-white px-3 py-1 hover:bg-gray-50">
                            Next
                        </a>
                    )}
                    {page.url.last && (
                        <a href={page.url.last} class="rounded border bg-white px-3 py-1 hover:bg-gray-50">
                            Last
                        </a>
                    )}
                </div>
            </nav>
        </main>
    </MainLayout>