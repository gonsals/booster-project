---
import "@/styles/global.css";
import MainLayout from "@/layouts/MainLayout.astro";
import FilterButton from "@/components/FilterButton.astro";
import type { ScryfallCard } from "@/types/scryfall/ScryFallCard";

export const prerender = false;

const { code } = Astro.params;
const url = Astro.url;

// query params
const sort = url.searchParams.get("sort") ?? "value";
const fun = url.searchParams.get("fun");
const art = url.searchParams.get("art");

const filterButtons = [
    {
        label: "Valor",
        key: "sort",
        value: "value",
        isActive: () => sort === "value",
    },
    {
        label: "EDHREC",
        key: "sort",
        value: "rank",
        isActive: () => sort === "rank",
    },
    {
        label: "Collector",
        key: "fun",
        value: "boosterfun",
        isActive: () => fun === "boosterfun",
    },
    {
        label: "Full Art",
        key: "art",
        value: "full",
        isActive: () => art === "full",
    },
];

/* Helper toggle */
function toggle(key: string, value: string) {
    const params = new URLSearchParams(url.search);

    if (params.get(key) === value) {
        params.delete(key);
    } else {
        params.set(key, value);
    }

    return "?" + params.toString();
}

/* ===== SCRYFALL ===== */

let allCards: ScryfallCard[] = [];
let pageUrl: string =
    `https://api.scryfall.com/cards/search` +
    `?q=e:${code}` +
    `&unique=prints` +
    `&fields=` +
    [
        "id",
        "name",
        "set_name",
        "rarity",
        "prices",
        "image_uris",
        "booster",
        "promo",
        "promo_types",
        "digital",
        "full_art",
        "edhrec_rank",
    ].join(",");

while (pageUrl) {
    const res = await fetch(pageUrl, {
        headers: {
            Accept: "application/json",
            "Cache-Control":
                "public, s-maxage=21600, stale-while-revalidate=86400",
        },
    });

    if (!res.ok) break;

    const json = await res.json();
    allCards.push(...json.data);
    pageUrl = json.has_more ? json.next_page : null;
}

/* ===== BASE FILTER ===== */
let cards: ScryfallCard[] = allCards.filter((c) => {
    if (!c.image_uris?.normal) return false;

    if (fun !== "boosterfun" && c.promo_types?.includes("boosterfun")) {
        return false;
    }

    if (art === "full" && c.full_art !== true) {
        return false;
    }

    return true;
});

/* ===== SORT ===== */

function getPrice(card: ScryfallCard): number {
    const p = card.prices;
    if (!p) return 0;

    return (p.usd && Number(p.usd)) || (p.usd_foil && Number(p.usd_foil)) || 0;
}

// DESC sort
if (sort === "rank") {
    cards.sort((a, b) => (a.edhrec_rank ?? 999999) - (b.edhrec_rank ?? 999999));
} else {
    cards.sort((a, b) => {
        const aPrice = getPrice(a);
        const bPrice = getPrice(b);
        return bPrice - aPrice; // DESC
    });
}
---

<MainLayout
    content={{ title: `Boosters – ${code?.toUpperCase()}`, code }}
    showNav
>
    <main class="max-w-7xl mx-auto p-6">
        <!-- HEADER -->
        <header class="flex flex-wrap items-end justify-between gap-4 mb-8">
            <div>
                <h1
                    class="text-3xl font-extrabold tracking-tight"
                    transition:name={`set-title-${code}`}
                >
                    {cards[0]?.set_name ?? code?.toUpperCase()}
                </h1>
                <p class="mt-1 text-sm text-gray-600">
                    Set {code?.toUpperCase()} · Play Boosters
                    {fun === "boosterfun" && " + Collector"}
                </p>
            </div>

            <!-- FILTERS -->
            <div class="flex flex-wrap gap-2 text-sm">
                {
                    filterButtons.map((f) => (
                        <FilterButton
                            href={toggle(f.key, f.value)}
                            active={f.isActive()}
                        >
                            {f.label}
                        </FilterButton>
                    ))
                }
            </div>
        </header>

        <!-- GRID -->
        <section
            class="grid gap-5"
            style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));"
        >
            {
                cards.map((card) => (
                    <article class="bg-white rounded-xl border hover:shadow-md transition overflow-hidden">
                        <img
                            src={card.image_uris?.normal}
                            alt={card.name}
                            loading="lazy"
                            class="w-full"
                        />

                        <div class="p-3 text-sm">
                            <h2 class="font-semibold truncate">{card.name}</h2>

                            <div class="mt-1 flex justify-between text-xs text-gray-600">
                                <span class="capitalize">{card.rarity}</span>

                                {card.prices?.usd ? (
                                    <span class="font-semibold">
                                        ${card.prices.usd}
                                    </span>
                                ) : card.prices?.usd_foil !== null ? (
                                    <span class="font-semibold">
                                        ${card.prices.usd_foil}
                                    </span>
                                ) : (
                                    <span class="text-gray-400">—</span>
                                )}
                            </div>

                            {card.edhrec_rank && (
                                <div class="mt-1 text-xs text-gray-400">
                                    EDHREC #{card.edhrec_rank}
                                </div>
                            )}
                        </div>
                    </article>
                ))
            }
        </section>

        {
            cards.length === 0 && (
                <p class="mt-10 text-sm text-gray-600">
                    No hay cartas para estos filtros.
                </p>
            )
        }
    </main>
</MainLayout>
